<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Leonardo Egidi" />

<meta name="date" content="2022-02-18" />

<title>Fitting football models and visualizing predictions with the footBayes package</title>


<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Fitting football models and visualizing predictions with the <code>footBayes</code> package</h1>
<h4 class="author">Leonardo Egidi</h4>
<h4 class="date">2022-02-18</h4>


<div id="TOC">
<ul>
<li><a href="#modeling-football-outcomes">Modeling football outcomes</a><ul>
<li><a href="#bivariate-poisson-model">Bivariate-Poisson model</a><ul>
<li><a href="#likelihood-approach">Likelihood approach</a></li>
<li><a href="#bayesian-approach">Bayesian approach</a></li>
</ul></li>
</ul></li>
<li><a href="#installing-the-package">Installing the package</a></li>
<li><a href="#model-fit">Model fit</a><ul>
<li><a href="#static-fit">Static fit</a><ul>
<li><a href="#changing-default-priors">Changing default priors</a></li>
</ul></li>
<li><a href="#dynamic-fit">Dynamic fit</a></li>
</ul></li>
<li><a href="#model-estimates-and-visualization-tools">Model estimates and visualization tools</a><ul>
<li><a href="#plotting-and-interpreting-team-specific-abilities">Plotting and interpreting team-specific abilities</a></li>
</ul></li>
<li><a href="#model-checking">Model checking</a></li>
<li><a href="#predictions-and-predictive-accuracy">Predictions and predictive accuracy</a><ul>
<li><a href="#posterior-out-of-sample-probabilities">Posterior out-of-sample probabilities</a></li>
<li><a href="#home-win-posterior-probabilities">Home-win posterior probabilities</a></li>
<li><a href="#rank-league-reconstruction">Rank-league reconstruction</a></li>
<li><a href="#model-comparisons-looic-and-waic">Model comparisons: LOOIC and WAIC</a></li>
</ul></li>
<li><a href="#extensions-in-next-versions">Extensions in next versions</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>

<!-- -->
<div id="modeling-football-outcomes" class="section level1">
<h1>Modeling football outcomes</h1>
<p>Modeling football outcomes became incredibly popular over the last years. However, an <strong>encompassing computational tool</strong> able to fit in one step many alternative football models is missing yet.</p>
<p>With the <code>footBayes</code> package we want to fill the gap and to give the possibility to <strong>fit, interpret and graphically explore</strong> the following goal-based Bayesian football models using the underlying Stan (<span style="color:red"> <span class="citation">Stan Development Team (2020)</span></span>) environment:</p>
<ul>
<li><p><span style="color:green">Double Poisson</span>: <span style="color:red"> <span class="citation">Baio and Blangiardo (2010)</span>, <span class="citation">Groll, Schauberger, and Tutz (2015)</span>, <span class="citation">Egidi, Pauli, and Torelli (2018)</span> </span></p></li>
<li><p><span style="color:green">Bivariate Poisson</span>: <span style="color:red"> <span class="citation">Karlis and Ntzoufras (2003)</span> </span></p></li>
<li><p><span style="color:green">Skellam</span> for goals’ differences: <span style="color:red"> <span class="citation">Karlis and Ntzoufras (2009)</span> </span></p></li>
<li><p><span style="color:green">Student-<span class="math inline">\(t\)</span></span> for goals’ differences: <span style="color:red"> <span class="citation">Gelman (2014)</span> </span></p></li>
<li><p><span style="color:green">Zero-Inflated Poisson</span>: <span style="color:red"><span class="citation">Karlis and Ntzoufras (2003)</span> </span> (<em>coming soon!</em>),</p></li>
</ul>
<p>Precisely, we’ll learn how to:</p>
<ul>
<li><p>fit <strong>static</strong> maximum likelihood and Bayesian models;</p></li>
<li><p>fit <strong>dynamic</strong> Bayesian models;</p></li>
<li><p>change the prior distributions and perform some <strong>sensitivity tests</strong>;</p></li>
<li><p>interpret <strong>parameters’ estimates</strong>;</p></li>
<li><p>retrieve predictive intervals for team-specific <strong>football abilities</strong>;</p></li>
<li><p>check the models through graphical <strong>posterior predictive checks</strong>;</p></li>
<li><p>obtain out-of-sample <strong>predictions</strong>;</p></li>
<li><p>reconstruct the final <strong>rank’s league</strong>;</p></li>
<li><p>compare models.</p></li>
</ul>
<p>The package is also available at the following link:</p>
<p><a href="https://github.com/LeoEgidi/footBayes">https://github.com/LeoEgidi/footBayes</a></p>
<p>In my opinion building packages is like an art’s work, likely to be <em>never-ending</em>. To say in art’s terms, I love this quote from Antoine de Saint-Exupéry (partially rephrased):</p>
<blockquote>
<p>“A (software) designer knows that he has reached perfection not when there is nothing more to add, but when there is nothing left to take away!”</p>
</blockquote>
<div id="bivariate-poisson-model" class="section level2">
<h2>Bivariate-Poisson model</h2>
<p>One main concern with the double Poisson model relies on the fact that the goals scored during a match by two competing teams are conditionally independent. However, in team sports, such as football, water-polo, handball, hockey, and basketball it is reasonable to assume that the two outcome variables are <strong>correlated</strong> since <strong>the two teams interact during the game</strong>. Consider, for instance, the realistic football case of the home team leading with 1-0, when only ten minutes are left to play. The away team can then become more determined and can take more risk in an effort to score and achieve the draw within the end of the match. Or, even when one of the two teams is leading say with 3-0, or 4-0, it is likely it will be relaxing a bit, and the opposing team could score at least one goal quite easily. To this aim, goals’ correlation due to a change in the behaviour of the team or both teams could be captured by a dependence parameter, accounting for positive correlation. Positive parametric goals’ dependence is made possible by using a <strong>bivariate Poisson distribution</strong>.</p>
<p>Consider random variables <span class="math inline">\(X_r, r =1,2,3\)</span>, which follow independent Poisson distributions with parameters <span class="math inline">\(\lambda_r &gt;0\)</span>. Then the random variables <span class="math inline">\(X=X_1 + X_3\)</span> and <span class="math inline">\(Y =X_2 + X_3\)</span> jointly follow a bivariate Poisson distribution <span class="math inline">\(\text{BP}(\lambda_1, \lambda_2, \lambda_3)\)</span>, with joint probability function</p>
<p><span class="math display">\[\begin{align}
\begin{split}
P_{X, Y}(x,y)&amp;= \textrm{Pr}(X=x, Y=y)\\
&amp;= \exp \{ -(\lambda_1+\lambda_2+\lambda_3) \}\frac{\lambda_1^x}{x!}\frac{\lambda_2^y}{y!}\times \\
&amp; \sum_{k=0}^{\min{(x,y)}}\binom{x}{k}\binom{y}{k}k!\left( \frac{\lambda_3}{\lambda_1 \lambda_2}  \right)^k.
\end{split}
\label{eq:biv_density}
\end{align}\]</span></p>
<p>Marginally each random variable follows a Poisson distribution with <span class="math inline">\(\textrm{E}(X)=\lambda_{1}+\lambda_{3}, \ \textrm{E}(Y)=\lambda_{2}+\lambda_{3}\)</span>, and <span class="math inline">\(\textrm{cov}(X,Y)=\lambda_{3}\)</span>; <span class="math inline">\(\lambda_{3}\)</span> acts as a measure of dependence between the goals scored by the two competing teams. If <span class="math inline">\(\lambda_3 = 0\)</span> then the two variables are conditionally independent and the bivariate Poisson distribution reduces to the product of two independent Poisson distributions, the double Poisson case.</p>
<p>Let <span class="math inline">\((x_{n}, y_{n})\)</span> denote the observed number of goals scored by the home and the away team in the <span class="math inline">\(n\)</span>-th game, respectively. A general bivariate Poisson model allowing for goals’ correlation, as in <span style="color:red"><span class="citation">Karlis and Ntzoufras (2003)</span> </span> is the following:</p>
<p><span class="math display">\[\begin{align}
X_n, Y_n| \lambda_{1n}, \lambda_{2n}, \lambda_{3n} &amp; \sim \mathsf{BivPoisson}(\lambda_{1n}, \lambda_{2n}, \lambda_{3n})\\
\log(\lambda_{1n})  &amp; = \mu+\text{home}+ \text{att}_{h_n}+\text{def}_{a_n}\\
\log(\lambda_{2n})  &amp; = \mu +\text{att}_{a_n}+\text{def}_{h_n}\\
\log(\lambda_{3n})  &amp;=\beta_0 + \gamma_1 \beta^{\text{home}}_{h_n}+\gamma_2\beta^{\text{away}}_{a_n} + \gamma_3\boldsymbol{\beta} w_n,
\end{align}\]</span></p>
<p>where <span class="math inline">\(\lambda_{1n}, \lambda_{2n}\)</span> represent the <strong>scoring rates</strong> for the home and the away team, respectively; <span class="math inline">\(\mu\)</span> represents the <strong>constant intercept</strong>; <span class="math inline">\(\text{home}\)</span> represents the <strong>home-effect</strong>, i.e. the well-known advantage of the team hosting the game; <span class="math inline">\(\text{att}_t\)</span> and <span class="math inline">\(\text{def}_t\)</span> represent the <strong>attack</strong> and the <strong>defence</strong> abilities, respectively, for each team <span class="math inline">\(t\)</span>, <span class="math inline">\(t=1,\ldots,T\)</span>; the nested indexes <span class="math inline">\(h_{n}, a_{n}=1,\ldots,T\)</span> denote the home and the away team playing in the <span class="math inline">\(n\)</span>-th game, respectively; <span class="math inline">\(\beta_0\)</span> is a constant parameter; <span class="math inline">\(\beta^{\text{home}}_{h_n}\)</span> and <span class="math inline">\(\beta^{\text{away}}_{a_n}\)</span> are parameters that depend on the home and away team respectively, <span class="math inline">\(w_{n}\)</span> is a vector of covariates for the <span class="math inline">\(n\)</span>-th match used to model the covariance term and <span class="math inline">\(\boldsymbol{\beta}\)</span> is the corresponding vector of regression coefficients. The parameters <span class="math inline">\(\gamma_1, \gamma_2\)</span> and <span class="math inline">\(\gamma_3\)</span> are dummy binary indicators taking values 0 or 1 which may activate distinct sources of the linear predictor. Hence when <span class="math inline">\(\gamma_1=\gamma_2=\gamma_3=0\)</span> we consider constant covariance as in <span style="color:red"><span class="citation">Egidi and Torelli (2020)</span> </span>, whereas when <span class="math inline">\((\gamma_1, \gamma_2, \gamma_3)=(1,1,0)\)</span> we assume that the covariance depends on the teams’ parameters only but not on further match covariates, and so on.</p>
<p>The case <span class="math inline">\(\lambda_{3n}=0\)</span> (the scores’ correlation parameter equals zero) reduces to the double Poisson model, as in <span style="color:red"><span class="citation">Baio and Blangiardo (2010)</span> </span>.</p>
<p>To achieve model’s identifiability, attack/defence parameters are imposed a <strong>sum-to-zero</strong> constraint:</p>
<p><span class="math display">\[\begin{equation}
\sum_{t=1}^{T} \text{att}_{t}=0, \ \sum_{t=1}^{T}\text{def}_{t}=0.
\label{eq:sum_to_zero}
\end{equation}\]</span></p>
<p>Another identifiability constraint, largely proposed in the football literature, is the <strong>corner</strong>-constraint, which assumes the abilities for the <span class="math inline">\(T\)</span>-th team are equal to the negative sum of the others, and then achieves a sum-to-zero as well:</p>
<p><span class="math display">\[\begin{equation}
\text{att}_T= -\sum_{t=1}^{T-1} \text{att}_{t}, \ \text{def}_T=- \sum_{t=1}^{T-1}\text{def}_{t}.
\label{eq:corner2}
\end{equation}\]</span></p>
<p>Now it’s time to fit and interpret the models, and we’ll mainly focus on the bivariate Poisson case. Classical estimates for BP models are provided, among the others, by <span style="color:red"><span class="citation">Karlis and Ntzoufras (2003)</span></span> (MLE through an EM algorithm) and <span style="color:red"><span class="citation">Koopman and Lit (2015)</span></span>; in the following, we quickly revise the maximum likelihood approach, but we’ll deeply focus on Bayesian estimation with the underlying <code>rstan</code> software to better capture:</p>
<ul>
<li><p>parameters’ uncertainty;</p></li>
<li><p>predictions’ uncertainty;</p></li>
<li><p>model checking.</p></li>
</ul>
<p><!-- Instead of using the marginal number of goals, --> <!-- another alternative is to modelling directly --> <!-- the score difference $(y^{H}_{n}- y^{A}_{n})$. --> <!-- We can use the Poisson-difference distribution --> <!-- (or Skellam distribution) to model goal --> <!-- difference in the $n$-th match ( see <span style="color:red"> @karlis2009bayesian </span>): --></p>
<p><!-- \begin{align} --> <!-- y^{H}_{n}- y^{A}_{n}| \lambda_{1n}, \lambda_{2n} & \sim PD(\lambda_{1n}, \lambda_{2n}), --> <!-- \end{align} --></p>
<p><!-- and the scoring rates $\lambda_{1n}, \lambda_{2n}$ are --> <!-- unchanged with respect to the bivariate/double Poisson model. --></p>
<p><!-- If we want to use a continue distribution, we can --> <!-- use a student t distribution with 7 degrees of --> <!-- freedom as in <span style="color:red"> @gelman2014stan </span>: --></p>
<p><!-- \begin{align} --> <!-- y^{H}_{n}- y^{A}_{n} & \sim t(7, \text{ab}_{h_{n}}-\text{ab}_{a_n}, \sigma_y)\\ --> <!-- \text{ab}_T &\sim \mathcal{N}(\mu + b \times \text{prior_score}_T, \sigma_{\text{ab}}), --> <!-- \end{align} --></p>
<p><!-- where $\text{ab}_T$ is the overall ability for --> <!-- the $T$-th team, whereas $\text{prior_score}_T$ --> <!-- is a prior measure of team's strength (for instance a --> <!-- ranking). --></p>
<div id="likelihood-approach" class="section level3">
<h3>Likelihood approach</h3>
<p>Given the parameter-vector <span class="math inline">\(\boldsymbol{\theta}= (\{\text{att}_t,\text{def}_t,t=1,\ldots,T \}, \mu, \text{home}, \beta^{\text{home}}_{h_n}, \beta^{\text{away}}_{a_n}, \beta_0, \boldsymbol{\beta})\)</span>, the likelihood function of the bivariate Poisson model above takes the following form:</p>
<p><span class="math display">\[\begin{eqnarray}
L(\boldsymbol{\theta})   = &amp; \prod_{n=1}^N \exp \{ -(\lambda_{1n}+\lambda_{2n}+\lambda_{3n}) \}\frac{\lambda_{1n}^{x_n}}{{x_n}!}\frac{\lambda_{2n}^{y_n}}{{y_n}!}\times \\ &amp;\sum_{k=0}^{\min{(x_n,y_n)}}\binom{x_n}{k}\binom{y_n}{k}k!\left( \frac{\lambda_{3n}}{\lambda_{1n} \lambda_{2n}}  \right)^k.
\label{eq:lik_biv}
\end{eqnarray}\]</span></p>
<p>Maximum-likelihood parameters estimation can be performed by searching the MLE <span class="math inline">\(\hat{\boldsymbol{\theta}}\)</span> such that:</p>
<p><span class="math display">\[\hat{\boldsymbol{\theta}} = \underset{\theta \in \Theta}{\text{argmax}}\ L(\boldsymbol{\theta}),\]</span></p>
<p>by imposing the following system of partial (log)-likelihood equations:</p>
<p><span class="math display">\[l&#39;(\boldsymbol{\theta})=0.\]</span> Wald and deviance-confidence intervals may be constructed for the MLE <span class="math inline">\(\hat{\boldsymbol{\theta}}\)</span>. A 95% Wald-type interval satisfies:</p>
<p><span class="math display">\[\hat{\boldsymbol{\theta}} \pm 1.96 \ \text{se}(\hat{\boldsymbol{\theta}}).\]</span> As we’ll see, the <code>footBayes</code> package allows the MLE computational approach (along with Wald-type and profile-likelihood confidence intervals) for static models only, i.e. when the model complexity is considered acceptable. As the parameters’ space grows—as it commonly happens when adding dynamic patterns—MLE becomes computationally expensive and less reliable.</p>
</div>
<div id="bayesian-approach" class="section level3">
<h3>Bayesian approach</h3>
<p>The goal of the Bayesian analysis is to carry out inferential conclusions from the joint posterior distribution <span class="math inline">\(\pi(\boldsymbol{\theta}|\mathcal{D})\)</span>, where <span class="math inline">\(\mathcal{D}= (x_n, y_n)_{n=1,\ldots,N}\)</span> denotes the set of observed data for the <span class="math inline">\(N\)</span> matches. The joint posterior satisfies</p>
<p><span class="math display">\[\pi(\boldsymbol{\theta}|\mathcal{D}) = \frac{p(\mathcal{D}|\boldsymbol{\theta})\pi(\boldsymbol{\theta})}{p(\mathcal{D})} \propto p(\mathcal{D}|\boldsymbol{\theta})\pi(\boldsymbol{\theta}),\]</span></p>
<p>where <span class="math inline">\(p(\mathcal{D}|\boldsymbol{\theta})\)</span> is the model sampling distribution (proportional to the likelihood function), <span class="math inline">\(\pi(\boldsymbol{\theta})\)</span> is the joint prior distribution for <span class="math inline">\(\boldsymbol{\theta}\)</span>, and <span class="math inline">\(p(\mathcal{D})= \int_{\Theta} p(\mathcal{D}|\boldsymbol{\theta})\pi(\boldsymbol{\theta}) d\theta\)</span> is the marginal likelihood that does not depend on <span class="math inline">\(\theta\)</span>.</p>
<p>In the majority of the cases, <span class="math inline">\(\pi(\boldsymbol{\theta}|\mathcal{D})\)</span> does not have a closed form and for such reason we need to approximate it by simulation. The most popular class of algorithms designed to achieve this task is named <strong>Markov Chain Monte Carlo Methods</strong> (see <span style="color:red"><span class="citation">Robert and Casella (2013)</span></span> for a deep theoretical overview). These methods allow to sample weak correlated samples from some Markov chains whose stationary and limiting distribution coincide with the posterior distribution that we wish to approximate and sample from.</p>
<p>The <code>footBayes</code> package relies on a sophisticated MCMC enginery, namely the <strong>Hamiltonian Monte Carlo</strong> performed by the Stan software: the HMC borrow its name from the Hamiltonian dynamics of physics and is aimed at suppressing random-walk and wasteful behaviours in the exploration of the posterior distribution which typically arise when using the Gibbs sampling and the Metropolis-Hastings algorithm. For a deep and great summary about HMC, you may read the paper <span style="color:red"><span class="citation">Betancourt (2017)</span></span>.</p>
<p>In terms of inferential conclusions, we are usually interested in summaries from the marginal posterior distributions of the single parameters: posterior means, medians, credibility intervals, etc.. We can write out the formula for the posterior distribution of the bivariate Poisson model above as:</p>
<p><span class="math display">\[\pi(\boldsymbol{\theta}|\mathcal{D}) \propto \pi(\boldsymbol{\theta}) \prod_{n=1}^N \mathsf{BivPoisson}(\lambda_{1n}, \lambda_{2n}, \lambda_{3n}),\]</span></p>
<p>where <span class="math inline">\(\pi(\boldsymbol{\theta})= \pi(\text{att}) \pi(\text{def})\pi(\mu)\pi(\text{home}) \pi(\beta^{\text{home}}_{h_n})\pi( \beta^{\text{away}}_{a_n})\pi(\beta_0)\pi(\boldsymbol{\beta})\)</span> is the joint ptior distribution under the assumption of a-priori independent parameters’ components.</p>
<p>The standard approach is to assign some <strong>weakly-informative</strong> prior distributions to the team-specific abilities. These parameters are considered <strong>exchangeable</strong> from two common (prior) distributions:</p>
<p><span class="math display">\[\begin{align}
 \text{att}_t &amp;\sim \mathcal{N}(\mu_{\text{att}}, \sigma_{\text{att}})\\
 \text{def}_t &amp;\sim \mathcal{N}(\mu_{\text{def}}, \sigma_{\text{def}}), \ \  t= \ 1,\ldots,T,
 \end{align}\]</span></p>
<p>with <strong>hyperparameters</strong> <span class="math inline">\(\mu_{\text{att}}, \sigma_{\text{att}}, \mu_{\text{def}}, \sigma_{\text{def}}\)</span>. The model formulation is completed by assigning some weakly-informative priors to the remaining parameters. In what follows, some priors’ options will be handled directly by the user.</p>
</div>
</div>
</div>
<div id="installing-the-package" class="section level1">
<h1>Installing the package</h1>
<p>Let’s install the <code>footBayes</code> package from Github:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(devtools)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">install_github</span>(<span class="st">&quot;LeoEgidi/footBayes&quot;</span>)</a></code></pre></div>
<p>and load the following required packages (please, install them on your laptops):</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">library</span>(footBayes)</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">library</span>(engsoccerdata)</a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">library</span>(bayesplot)</a>
<a class="sourceLine" id="cb2-4" title="4"><span class="kw">library</span>(loo)</a>
<a class="sourceLine" id="cb2-5" title="5"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb2-6" title="6"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb2-7" title="7"><span class="kw">library</span>(tidyverse)</a></code></pre></div>
</div>
<div id="model-fit" class="section level1">
<h1>Model fit</h1>
<div id="static-fit" class="section level2">
<h2>Static fit</h2>
<p>To start with some analysis, let’s now import some data about the Italian Serie A, season 2000/2001, through the <code>engsoccerdata</code> package: the season consists of <span class="math inline">\(T=18\)</span> teams, we start fitting a static bivariate Poisson model using:</p>
<ul>
<li><p>the likelihood approach: the <code>mle_foot</code> function returns the MLE estimates along with 95% profile-likelihood deviance confidence intervals (by default) and Wald-type confidence intervals. The user can specify the desired confidence interval with the optional argument <code>interval = c(&quot;profile&quot;, &quot;Wald&quot;)</code>.</p></li>
<li><p>the Bayesian approach: the <code>stan_foot</code> function produces an Hamiltonian Monte Carlo posterior sampling by using the underlying <code>rstan</code> ecosystem. The user can choose the number of iterations (<code>iter</code>), the number of Markov chains (<code>chains</code>), and other optional arguments values. With the <code>print</code> function, the usual Bayesian model summaries can be obtained: posterior means, medians, standard deviations, percentiles at 2.5%, 25%, 75%, 97.5% level, effective sample size (<code>n_eff</code>) and Gelman-Rubin statistic (<code>Rhat</code>).</p></li>
</ul>
<p>At this stage, we are currently ignoring any time-dependence in our parameters, considering them to be <strong>static</strong> across distinct match-times.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="co">### Use Italian Serie A 2000/2001</span></a>
<a class="sourceLine" id="cb3-3" title="3"></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="co">## with &#39;tidyverse&#39; environment</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="co">#</span></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="co">#library(tidyverse)</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="co">#italy &lt;- as_tibble(italy)</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="co">#italy_2000&lt;- italy %&gt;%</span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="co">#  dplyr::select(Season, home, visitor, hgoal,vgoal) #%&gt;%</span></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="co">#  dplyr::filter(Season==&quot;2000&quot;)</span></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="co">#italy_2000</span></a>
<a class="sourceLine" id="cb3-12" title="12"></a>
<a class="sourceLine" id="cb3-13" title="13"><span class="co">## alternatively, you can use the basic &#39;subsetting&#39; code, </span></a>
<a class="sourceLine" id="cb3-14" title="14"><span class="co">## not using the &#39;tidyverse&#39; environment: </span></a>
<a class="sourceLine" id="cb3-15" title="15"><span class="kw">data</span>(italy)</a>
<a class="sourceLine" id="cb3-16" title="16">italy &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(italy)</a>
<a class="sourceLine" id="cb3-17" title="17">italy_<span class="dv">2000</span> &lt;-<span class="st"> </span><span class="kw">subset</span>(italy[, <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">6</span>,<span class="dv">7</span>)], </a>
<a class="sourceLine" id="cb3-18" title="18">                     Season <span class="op">==</span><span class="st">&quot;2000&quot;</span>)</a>
<a class="sourceLine" id="cb3-19" title="19"><span class="kw">head</span>(italy_<span class="dv">2000</span>)</a>
<a class="sourceLine" id="cb3-20" title="20"></a>
<a class="sourceLine" id="cb3-21" title="21"><span class="co">### Fit Stan models</span></a>
<a class="sourceLine" id="cb3-22" title="22"><span class="co">## no dynamics, no predictions</span></a>
<a class="sourceLine" id="cb3-23" title="23"><span class="co">## 4 Markov chains, &#39;n_iter&#39; iterations each</span></a>
<a class="sourceLine" id="cb3-24" title="24"></a>
<a class="sourceLine" id="cb3-25" title="25">n_iter &lt;-<span class="st"> </span><span class="dv">200</span>    <span class="co"># number of MCMC iterations</span></a>
<a class="sourceLine" id="cb3-26" title="26">fit1_stan &lt;-<span class="st"> </span><span class="kw">stan_foot</span>(<span class="dt">data =</span> italy_<span class="dv">2000</span>,</a>
<a class="sourceLine" id="cb3-27" title="27">                       <span class="dt">model=</span><span class="st">&quot;biv_pois&quot;</span>,</a>
<a class="sourceLine" id="cb3-28" title="28">                       <span class="dt">chains =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb3-29" title="29">                       <span class="co">#cores = 4,</span></a>
<a class="sourceLine" id="cb3-30" title="30">                       <span class="dt">iter =</span> n_iter) <span class="co"># biv poisson</span></a>
<a class="sourceLine" id="cb3-31" title="31"></a>
<a class="sourceLine" id="cb3-32" title="32"><span class="co">## print of model summary for parameters:</span></a>
<a class="sourceLine" id="cb3-33" title="33"><span class="co">## home, sigma_att, sigma_def</span></a>
<a class="sourceLine" id="cb3-34" title="34"></a>
<a class="sourceLine" id="cb3-35" title="35"><span class="kw">print</span>(fit1_stan, <span class="dt">pars =</span><span class="kw">c</span>(<span class="st">&quot;home&quot;</span>, <span class="st">&quot;rho&quot;</span>, <span class="st">&quot;sigma_att&quot;</span>,</a>
<a class="sourceLine" id="cb3-36" title="36">                         <span class="st">&quot;sigma_def&quot;</span>))</a></code></pre></div>
<p>The <strong>Gelman-Rubin statistic</strong> <span class="math inline">\(\hat{R}\)</span> (<code>Rhat</code>) is below the threshold 1.1 for all the parameters, whereas the <strong>effective sample size</strong> (<code>n_eff</code>), measuring the approximate number of iid replications from the Markov chains, does not appear to be problematic. Thus, HMC sampling reached the convergence.</p>
<p>As we could expect, there is a positive effect from the home-effect (posterior mean about 0.3), and this implies that if two teams are equally good (meaning that their attack and defence abilities almost coincide), assuming that the constant intercept <span class="math inline">\(\mu \approx 0\)</span>, we get that the average number of goals for the home-team will be <span class="math inline">\(\lambda_{1} = \exp \{0.3 \} \approx 1.35\)</span>, against <span class="math inline">\(\lambda_{2} = \exp \{0 \} = 1\)</span>.</p>
<p>In the model above, we are assuming that the covariance <span class="math inline">\(\lambda_{3n}\)</span> is constant and not depending on the match and/or on teams characteristics/further covariates:</p>
<p><span class="math display">\[\begin{align}
\lambda_{3n} =&amp;\ \exp\{\rho\}\\
\rho \sim &amp; \ \mathcal{N}^+(0,1),\\
\end{align}\]</span></p>
<p>where <span class="math inline">\(\rho\)</span> is assigned an half-Gaussian distribution with standard deviation equal to 1. According to the fit above, this means that in the model above we get an estimate of <span class="math inline">\(\lambda_{3n}= \exp\{-4.25\} \approx 0.014\)</span>, suggesting a low, despite non-null, amount of goals-correlation existing in the 2000/2001 Italian Serie A. Of course, in the next package’s version, the user will be allowed to specify a more general linear predictor for <span class="math inline">\(\log(\lambda_{3n})\)</span>, as outlined in the BP presentation above, along with some prior distributions for the parameters involved in the covariance formulation.</p>
<p>We can also depict the marginal posterior distributions for <span class="math inline">\(\rho\)</span> (and eventually for the other fixed-effects parameters) using the <code>bayesplot</code> package for Bayesian visualizations:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="co">## Marginal posterior with bayesplot</span></a>
<a class="sourceLine" id="cb4-2" title="2"></a>
<a class="sourceLine" id="cb4-3" title="3">posterior1 &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(fit1_stan)</a>
<a class="sourceLine" id="cb4-4" title="4"><span class="kw">mcmc_areas</span>(posterior1, <span class="dt">regex_pars=</span><span class="kw">c</span>(<span class="st">&quot;home&quot;</span>, <span class="st">&quot;rho&quot;</span>,</a>
<a class="sourceLine" id="cb4-5" title="5">  <span class="st">&quot;sigma_att&quot;</span>, <span class="st">&quot;sigma_def&quot;</span>))</a></code></pre></div>
<p>We can also access the original BP Stan code by typing:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="co">### Model&#39;s code extraction</span></a>
<a class="sourceLine" id="cb5-2" title="2"></a>
<a class="sourceLine" id="cb5-3" title="3">fit1_stan<span class="op">@</span>stanmodel</a></code></pre></div>
<p>We fit now the same model under the MLE approach with Wald-type confidence intervals. We can then print the MLE estimates, e.g for the parameters <span class="math inline">\(\rho\)</span> and <span class="math inline">\(\text{home}\)</span>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="co">### Fit MLE models</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="co">## no dynamics, no predictions</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="co">## Wald intervals</span></a>
<a class="sourceLine" id="cb6-4" title="4"></a>
<a class="sourceLine" id="cb6-5" title="5">fit1_mle &lt;-<span class="st"> </span><span class="kw">mle_foot</span>(<span class="dt">data =</span> italy_<span class="dv">2000</span>,</a>
<a class="sourceLine" id="cb6-6" title="6">                     <span class="dt">model=</span><span class="st">&quot;biv_pois&quot;</span>,</a>
<a class="sourceLine" id="cb6-7" title="7">                     <span class="dt">interval =</span> <span class="st">&quot;Wald&quot;</span>) <span class="co"># mle biv poisson</span></a>
<a class="sourceLine" id="cb6-8" title="8">fit1_mle<span class="op">$</span>home</a></code></pre></div>
<p>We got a very similar estimate to the Bayesian model for the home-effect.</p>
<div id="changing-default-priors" class="section level3">
<h3>Changing default priors</h3>
<p>One of the common practices in Bayesian statistics is to change the priors and perform some <strong>sensitivity tests</strong>. The default priors for the team-specific abilities and their related team-level standard deviations are:</p>
<p><span class="math display">\[\begin{align}
 \text{att}_t &amp;\sim \mathcal{N}(\mu_{\text{att}}, \sigma_{\text{att}}),\\
 \text{def}_t &amp;\sim \mathcal{N}(\mu_{\text{def}}, \sigma_{\text{def}}),\\
 \sigma_{\text{att}},  \sigma_{\text{def}} &amp;\sim \mathsf{Cauchy}^+(0,5),
 \end{align}\]</span></p>
<p>where <span class="math inline">\(\mathsf{Cauchy}^+\)</span> denotes the half-Cauchy distribution with support <span class="math inline">\([0, +\infty)\)</span>. However, the user is free to elicit some different priors, possibly choosing one among the following distributions: Gaussian (<code>normal</code>), student-<span class="math inline">\(t\)</span> (<code>student_t</code>), Cauchy (<code>cauchy</code>) and Laplace (<code>laplace</code>). The <code>prior</code> optional argument allows to specify the priors for the team-specific parameters <span class="math inline">\(\text{att}\)</span> and <span class="math inline">\(\text{def}\)</span>, whereas the optional argument <code>prior_sd</code> allows to assign a prior to the group-level standard deviations <span class="math inline">\(\sigma_{\text{att}}, \sigma_{\text{def}}\)</span>. For instance, for each team <span class="math inline">\(t, t=1,\ldots,T\)</span>, we could consider:</p>
<p><span class="math display">\[\begin{align}
 \text{att}_t &amp;\sim t(4, \mu_{\text{att}}, \sigma_{\text{att}}),\\
 \text{def}_t &amp;\sim t(4, \mu_{\text{def}}, \sigma_{\text{def}}),\\
 \sigma_{\text{att}},  \sigma_{\text{def}} &amp;\sim \mathsf{Laplace}^+(0,1),
 \end{align}\]</span></p>
<p>where <span class="math inline">\(t(\text{df}, \mu, \sigma)\)</span> denotes a student-<span class="math inline">\(t\)</span> distribution with df degrees of freedom, location <span class="math inline">\(\mu\)</span> and scale <span class="math inline">\(\sigma\)</span>, whereas <span class="math inline">\(\mathsf{Laplace}^+\)</span> denotes a half-Laplace distribution.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="co">### Fit Stan models</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="co">## changing priors</span></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="co">## student-t for team-specific abilities, laplace for sds</span></a>
<a class="sourceLine" id="cb7-4" title="4"></a>
<a class="sourceLine" id="cb7-5" title="5">fit1_stan_t &lt;-<span class="st"> </span><span class="kw">stan_foot</span>(<span class="dt">data =</span> italy_<span class="dv">2000</span>,</a>
<a class="sourceLine" id="cb7-6" title="6">                         <span class="dt">model=</span><span class="st">&quot;biv_pois&quot;</span>,</a>
<a class="sourceLine" id="cb7-7" title="7">                         <span class="dt">chains =</span> <span class="dv">4</span>, </a>
<a class="sourceLine" id="cb7-8" title="8">                         <span class="dt">prior =</span> <span class="kw">student_t</span>(<span class="dv">4</span>,<span class="dv">0</span>,<span class="ot">NULL</span>),</a>
<a class="sourceLine" id="cb7-9" title="9">                         <span class="dt">prior_sd =</span> <span class="kw">laplace</span>(<span class="dv">0</span>,<span class="dv">1</span>),</a>
<a class="sourceLine" id="cb7-10" title="10">                         <span class="co">#cores = 4,</span></a>
<a class="sourceLine" id="cb7-11" title="11">                         <span class="dt">iter =</span> n_iter) <span class="co"># biv poisson</span></a></code></pre></div>
<p>Then, we can compare the marginal posteriors from the two models, the one with Gaussian team-specific abilities and the default <span class="math inline">\(\mathsf{Cauchy}(0,5)\)</span> for the team-level sds, and the other one specified above, with student-<span class="math inline">\(t\)</span> distributed team-specific abilities and the <span class="math inline">\(\mathsf{Laplace}^+(0,1)\)</span> for the team-level sds. We depict here the comparison for the attack team-level sds only:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="co">## comparing posteriors</span></a>
<a class="sourceLine" id="cb8-2" title="2"></a>
<a class="sourceLine" id="cb8-3" title="3">posterior1_t &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(fit1_stan_t)</a>
<a class="sourceLine" id="cb8-4" title="4">model_names &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Default&quot;</span>, <span class="st">&quot;Stud+Laplace&quot;</span>)</a>
<a class="sourceLine" id="cb8-5" title="5"><span class="kw">color_scheme_set</span>(<span class="dt">scheme =</span> <span class="st">&quot;gray&quot;</span>)</a>
<a class="sourceLine" id="cb8-6" title="6">gl_posterior &lt;-<span class="st"> </span><span class="kw">cbind</span>(posterior1[,<span class="st">&quot;sigma_att&quot;</span>], </a>
<a class="sourceLine" id="cb8-7" title="7">                      posterior1_t[,<span class="st">&quot;sigma_att&quot;</span>])</a>
<a class="sourceLine" id="cb8-8" title="8"><span class="kw">colnames</span>(gl_posterior)&lt;-<span class="kw">c</span>(<span class="st">&quot;sigma_att&quot;</span>, <span class="st">&quot;sigma_att_t&quot;</span>)</a>
<a class="sourceLine" id="cb8-9" title="9"><span class="kw">mcmc_areas</span>(gl_posterior, <span class="dt">pars=</span><span class="kw">c</span>(<span class="st">&quot;sigma_att&quot;</span>, <span class="st">&quot;sigma_att_t&quot;</span>))<span class="op">+</span></a>
<a class="sourceLine" id="cb8-10" title="10"><span class="st">  </span><span class="kw">xaxis_text</span>(<span class="dt">on =</span><span class="ot">TRUE</span>, <span class="dt">size=</span>ggplot2<span class="op">::</span><span class="kw">rel</span>(<span class="fl">2.9</span>))<span class="op">+</span></a>
<a class="sourceLine" id="cb8-11" title="11"><span class="st">  </span><span class="kw">yaxis_text</span>(<span class="dt">on =</span><span class="ot">TRUE</span>, <span class="dt">size=</span>ggplot2<span class="op">::</span><span class="kw">rel</span>(<span class="fl">2.9</span>))<span class="op">+</span></a>
<a class="sourceLine" id="cb8-12" title="12"><span class="st">  </span><span class="kw">scale_y_discrete</span>(<span class="dt">labels =</span> ((<span class="kw">parse</span>(<span class="dt">text=</span> model_names))))<span class="op">+</span></a>
<a class="sourceLine" id="cb8-13" title="13"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Att/def sds&quot;</span>)<span class="op">+</span></a>
<a class="sourceLine" id="cb8-14" title="14"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="fl">0.5</span>, <span class="dt">size =</span><span class="kw">rel</span>(<span class="fl">2.6</span>)))</a></code></pre></div>
<p>The student+laplace prior induces a lower amount of group-variability in the <span class="math inline">\(\sigma_{\text{att}}\)</span> marginal posterior distribution (then, a larger shrinkage towards the grand mean <span class="math inline">\(\mu_{\text{att}}\)</span>).</p>
<p>When specifying the prior for the team-specific parameters through the argument <code>prior</code>, you are not allowed to fix the group-level standard deviations <span class="math inline">\(\sigma_{\text{att}}, \sigma_{\text{def}}\)</span> to some numerical values. Rather, they need to be assigned a reasonable prior distribution. For such reason, the most appropriate specification for the <code>prior</code> argument is <code>prior = &#39;dist&#39;(0, NULL)</code>, where the scale argument is set to <code>NULL</code> (otherwise, a warning message is occurring).</p>
</div>
</div>
<div id="dynamic-fit" class="section level2">
<h2>Dynamic fit</h2>
<p>A structural limitation in the previous models is the assumption of static team-specific parameters, namely teams are assumed to have a constant performance across time, as determined by the attack and defence abilities (att, def). However, teams’ performance tend to be <em>dynamic</em> and change across different years, if not different weeks. Many factors contribute to this football aspect:</p>
<ol style="list-style-type: lower-roman">
<li><p>teams act during the summer/winter players’ transfermarket, by dramatically changing their rosters;</p></li>
<li><p>some teams’ players could be injured in some periods, by affecting the global quality of the team in some matches;</p></li>
<li><p>coaches could be dismissed from their teams due to some non satisfactory results;</p></li>
<li><p>some teams could improve/worsen their attitudes due to the so-called turnover;</p></li>
</ol>
<p>and many others. Perhaps, we could assume <strong>dynamics</strong> in the attach/defence abilities as in <span style="color:red"> <span class="citation">Owen (2011)</span> </span> and <span style="color:red"> <span class="citation">Egidi, Pauli, and Torelli (2018)</span></span> in terms of weeks or seasons. In such framework, for a given number of times <span class="math inline">\(1, \ldots, \mathcal{T}\)</span>, the models above would be unchanged, but the priors for the abilities parameters at each time <span class="math inline">\(\tau, \tau=2,\ldots, \mathcal{T},\)</span> would be <strong>auto-regressive</strong> of order 1:</p>
<p><span class="math display">\[\begin{align}
 \text{att}_{t, \tau} &amp; \sim \mathcal{N}({\text{att}}_{t, \tau-1}, \sigma_{\text{att}})\\
 \text{def}_{t, \tau} &amp;\sim \mathcal{N}({\text{def}}_{t, \tau-1}, \sigma_{\text{def}}),
 \end{align}\]</span></p>
<p>whereas for <span class="math inline">\(\tau=1\)</span> we have:</p>
<p><span class="math display">\[\begin{align}
 \text{att}_{t, 1} &amp; \sim \mathcal{N}(\mu_{\text{att}}, \sigma_{\text{att}})\\
 \text{def}_{t, 1} &amp;\sim \mathcal{N}(\mu_{\text{def}}, \sigma_{\text{def}}),
 \end{align}\]</span></p>
<p>with hyperparameters <span class="math inline">\(\mu_{\text{att}}, \mu_{\text{def}}, \sigma_{\text{att}}, \sigma_{\text{def}}\)</span> and with the standard deviations capturing the time’s/evolution’s variation of both the teams’ skills (here assumed to be constant across time and teams). Of course, the identifiability constraint must be imposed for each time <span class="math inline">\(\tau\)</span>.</p>
<p>We can use the <code>dynamic_type</code> argument in the <code>stan_foot</code> function, with possible options <code>&#39;seasonal&#39;</code> or <code>&#39;weekly&#39;</code> in order to consider more seasons (no examples are given in this course) or more week-times within a single season, respectively. Let’s fit a weekly-dynamic parameters model on the Serie A 2000/2001 season:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="co">### Fit Stan models</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="co">## seasonal dynamics, no predictions</span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="co">## 4 Markov chains, &#39;n_iter&#39; iterations each</span></a>
<a class="sourceLine" id="cb9-4" title="4"></a>
<a class="sourceLine" id="cb9-5" title="5">fit2_stan &lt;-<span class="st"> </span><span class="kw">stan_foot</span>(<span class="dt">data =</span> italy_<span class="dv">2000</span>,</a>
<a class="sourceLine" id="cb9-6" title="6">                       <span class="dt">model=</span><span class="st">&quot;biv_pois&quot;</span>,</a>
<a class="sourceLine" id="cb9-7" title="7">                       <span class="dt">dynamic_type =</span><span class="st">&quot;weekly&quot;</span>, </a>
<a class="sourceLine" id="cb9-8" title="8">                       <span class="co">#cores = 4,</span></a>
<a class="sourceLine" id="cb9-9" title="9">                       <span class="dt">iter =</span> n_iter) <span class="co"># biv poisson</span></a>
<a class="sourceLine" id="cb9-10" title="10"><span class="kw">print</span>(fit2_stan, <span class="dt">pars =</span><span class="kw">c</span>(<span class="st">&quot;home&quot;</span>, <span class="st">&quot;rho&quot;</span>, <span class="st">&quot;sigma_att&quot;</span>,</a>
<a class="sourceLine" id="cb9-11" title="11">                        <span class="st">&quot;sigma_def&quot;</span>))</a></code></pre></div>
<p>From the printed summary, we may note that the degree of goals’ correlation seems to be again very small here. Moreover, the Gelman-Rubin statistic for <span class="math inline">\(\sigma_{\text{att}}\)</span> is relatively high, whereas the effective sample sizes for <span class="math inline">\(\sigma_{\text{att}}\)</span> and <span class="math inline">\(\sigma_{\text{def}}\)</span> are quite low. This is suggesting possible inefficiencies during the HMC sampling and that a <em>model-reparametrization</em> could be suited and effective at this stage. Another option is to play a bit with the prior specification for <span class="math inline">\(\sigma_{\text{att}}\)</span> and <span class="math inline">\(\sigma_{\text{def}}\)</span>, for instance by specifying a prior inducing less shrinkage in the team-specific abilities.</p>
<p>To deal with these issues and broaden the set of candidate models, let’s fit also a dynamic double-Poisson model with the <code>double_pois</code> option for the argument <code>model</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="co">### Fit Stan models</span></a>
<a class="sourceLine" id="cb10-2" title="2"><span class="co">## weekly dynamics, no predictions</span></a>
<a class="sourceLine" id="cb10-3" title="3"><span class="co">## 4 chains, &#39;n_iter&#39; iterations each</span></a>
<a class="sourceLine" id="cb10-4" title="4"></a>
<a class="sourceLine" id="cb10-5" title="5">fit3_stan &lt;-<span class="st"> </span><span class="kw">stan_foot</span>(<span class="dt">data =</span> italy_<span class="dv">2000</span>,</a>
<a class="sourceLine" id="cb10-6" title="6">                       <span class="dt">model=</span><span class="st">&quot;double_pois&quot;</span>,</a>
<a class="sourceLine" id="cb10-7" title="7">                       <span class="dt">dynamic_type =</span> <span class="st">&quot;weekly&quot;</span>,</a>
<a class="sourceLine" id="cb10-8" title="8">                       <span class="co">#cores = 4,</span></a>
<a class="sourceLine" id="cb10-9" title="9">                       <span class="dt">iter =</span> n_iter)  <span class="co"># double poisson</span></a>
<a class="sourceLine" id="cb10-10" title="10"><span class="kw">print</span>(fit3_stan, <span class="dt">pars =</span><span class="kw">c</span>(<span class="st">&quot;home&quot;</span>, <span class="st">&quot;sigma_att&quot;</span>,</a>
<a class="sourceLine" id="cb10-11" title="11">                        <span class="st">&quot;sigma_def&quot;</span>))</a></code></pre></div>
<p>The fitting problems mentioned above remain also for the double Poisson model…Thus, it’s time to play a little bit with the prior distributions. Also in the dynamic approach we can change the default priors for the team-specific abilities and their standard deviations, respectively, through the optional arguments <code>prior</code> and <code>prior_sd</code>. The specification follows almost analogously the static case: with the first argument we may specify the prior’s family for the team-specific abilities and the specific priors for <span class="math inline">\(\text{att}_{t,1}, \text{def}_{t,1}\)</span> along with the hyper-prior location <span class="math inline">\(\mu_{\text{att}}, \mu_{\text{def}}\)</span>, whereas <span class="math inline">\(\sigma_{\text{att}}\)</span> and <span class="math inline">\(\sigma_{\text{def}}\)</span> need to be assigned some proper prior distribution. Assume to fit the same double Poisson model, but here we suppose student-<span class="math inline">\(t\)</span> distributed team-specific abilities with 4 degrees of freedom to eventually capture more extreme team-specific abilities (more variability, i.e. less shrinkage), along with a <span class="math inline">\(\text{Cauchy}^+(0,25)\)</span> for their standard deviations (to better capture a possible larger evolution variability):</p>
<p><span class="math display">\[\begin{align}
 \text{att}_{t, \tau} &amp;\ \sim t(4, {\text{att}}_{t, \tau-1}, \sigma_{\text{att}})\\
 \text{def}_{t, \tau} &amp;\ \sim t(4, {\text{def}}_{t, \tau-1}, \sigma_{\text{def}})\\
 \sigma_{\text{att}},  \sigma_{\text{def}} &amp;\ \sim \mathsf{Cauchy}^+(0,25),
 \end{align}\]</span></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="co">### Fit Stan models</span></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="co">## weekly dynamics, no predictions</span></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="co">## 4 chains, &#39;n_iter&#39; iterations each</span></a>
<a class="sourceLine" id="cb11-4" title="4"></a>
<a class="sourceLine" id="cb11-5" title="5">fit3_stan_t &lt;-<span class="st"> </span><span class="kw">stan_foot</span>(<span class="dt">data =</span> italy_<span class="dv">2000</span>,</a>
<a class="sourceLine" id="cb11-6" title="6">                <span class="dt">model=</span><span class="st">&quot;double_pois&quot;</span>,</a>
<a class="sourceLine" id="cb11-7" title="7">                <span class="dt">prior =</span> <span class="kw">student_t</span>(<span class="dv">4</span>,<span class="dv">0</span>, <span class="ot">NULL</span>), <span class="co"># 4 df</span></a>
<a class="sourceLine" id="cb11-8" title="8">                <span class="dt">prior_sd =</span> <span class="kw">cauchy</span>(<span class="dv">0</span>,<span class="dv">25</span>),</a>
<a class="sourceLine" id="cb11-9" title="9">                <span class="dt">dynamic_type =</span> <span class="st">&quot;weekly&quot;</span>,</a>
<a class="sourceLine" id="cb11-10" title="10">                <span class="co">#cores = 4,</span></a>
<a class="sourceLine" id="cb11-11" title="11">                <span class="dt">iter =</span> n_iter)  <span class="co"># double poisson</span></a>
<a class="sourceLine" id="cb11-12" title="12"><span class="kw">print</span>(fit3_stan_t, <span class="dt">pars =</span><span class="kw">c</span>(<span class="st">&quot;home&quot;</span>, <span class="st">&quot;sigma_att&quot;</span>,</a>
<a class="sourceLine" id="cb11-13" title="13">                           <span class="st">&quot;sigma_def&quot;</span>))</a></code></pre></div>
<p>As we may conclude, the situation has been only slightly improved.</p>
<!-- For student-$t$ model we obtain global abilities intervals: -->
<!-- ```{r t_dyn, echo =TRUE, eval = FALSE} -->
<!-- fit5 <- stan_foot(data = italy_2000, -->
<!--                 model="student_t", -->
<!--                 dynamic_type = "weekly", -->
<!--                 iter = 1000)  # student_t -->
<!-- foot_abilities(fit5, italy_2000) -->
<!-- ``` -->
</div>
</div>
<div id="model-estimates-and-visualization-tools" class="section level1">
<h1>Model estimates and visualization tools</h1>
<div id="plotting-and-interpreting-team-specific-abilities" class="section level2">
<h2>Plotting and interpreting team-specific abilities</h2>
<p>Once the model has been fitted, there is a large amount of interesting summaries to explore. The function <code>foot_abilities</code> allows to depict posterior/confidence intervals for global attack and defense abilities on the considered data (attack abilities are plotted in red, whereas defense abilities in blue colors). The <em>higher the attack and the lower the defence</em> for a given team, and <em>the better is the overall team’s strength</em>.</p>
<p>We can produce the team-specific abilities for the two static fits above, <code>fit1_mle</code> (MLE) and <code>fit1_stan</code> (Bayes), with red bars for the attack and blue bars for the defence, respectively:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="co">## Plotting abilities: credible and confidence 95% intervals</span></a>
<a class="sourceLine" id="cb12-2" title="2"></a>
<a class="sourceLine" id="cb12-3" title="3"><span class="kw">foot_abilities</span>(<span class="dt">object =</span> fit1_stan, <span class="dt">data =</span> italy_<span class="dv">2000</span>, <span class="dt">cex.var =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb12-4" title="4"><span class="kw">foot_abilities</span>(<span class="dt">object =</span> fit1_mle, <span class="dt">data =</span> italy_<span class="dv">2000</span>, <span class="dt">cex.var =</span> <span class="dv">1</span>)</a></code></pre></div>
<p>AS Roma, the team winning the Serie A 2000/2001, is associated with the highest attack ability and the lowest defence ability according to both the models. In general, the models seem to well capture the static abilities: AS Roma, Lazio Roma and Juventus (1st, 3rd and 2nd at the end of that season, respectively) are rated as the best teams in terms of their abilities, whereas AS Bari, SSC Napoli and Vicenza Calcio (all relegated at the end of the season) have the worst abilities.</p>
<p>We can also depict the team-specific dynamic plots for the dynamic models:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="co">## Plotting abilities: credible and confidence 95% intervals</span></a>
<a class="sourceLine" id="cb13-2" title="2"></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="kw">foot_abilities</span>(fit2_stan, italy_<span class="dv">2000</span>)</a></code></pre></div>
<p>As we can see, dynamic abilities naturally evolve over the time: better teams (AS Roma, Lazio Roma, Juventus, Parma) are associated with increasing attack abilities and decreasing defence abilities, whereas the worst ones (AS Bari, SSC NApoli, and Hellas Verona) exhibit decreasing attacking skills and increasing defensive skills. The reason for these increasing/decreasing behaviours is straightforward: at the beginning, all the attack/defence parameters have been initialized to have location equal to 0. The user is free to change the location, and in the final package’s version he will also have the possibility to elicit different team-specific hyper-prior locations.</p>
</div>
</div>
<div id="model-checking" class="section level1">
<h1>Model checking</h1>
<p>Checking the model fit is a relevant and vital statistical task. To this purpose, we can evaluate hypothetical replications <span class="math inline">\(\mathcal{D}^{\text{rep}}\)</span> under the <strong>posterior predictive distribution</strong></p>
<p><span class="math display">\[p(\mathcal{D}^{\text{rep}}| \mathcal{D}) = \int p(\mathcal{D}^{\text{rep}}| \boldsymbol{\theta}) \pi(\boldsymbol{\theta}| \mathcal{D}) d\boldsymbol{\theta},\]</span> and check whether these replicated values are somehow close to the observed data <span class="math inline">\(\mathcal{D}\)</span>. These methods comparing hypothetical replications with the observed data are named <strong>posterior predictive checks</strong> and have great theoretical and applied appeal in Bayesian inference. See <span style="color:red"><span class="citation">Gelman et al. (2014)</span></span> for an overview.</p>
<p>The function <code>pp_foot</code> allows to obtain:</p>
<ul>
<li><p>an aggregated plot depicting the observed frequencies of the observed goal differences <span class="math inline">\(Z_n=X_n-Y_n, \ n=1,\ldots,N\)</span> plotted against the replicated ones;</p></li>
<li><p>a visualization of the match-ordered goal differences along with their 50% and 95% credible intervals.</p></li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1"><span class="co">## PP checks: aggregated goal&#39;s differences and ordered goal differences</span></a>
<a class="sourceLine" id="cb14-2" title="2"></a>
<a class="sourceLine" id="cb14-3" title="3"><span class="kw">pp_foot</span>(<span class="dt">data =</span> italy_<span class="dv">2000</span>, <span class="dt">object =</span> fit1_stan, </a>
<a class="sourceLine" id="cb14-4" title="4">        <span class="dt">type =</span> <span class="st">&quot;aggregated&quot;</span>)</a>
<a class="sourceLine" id="cb14-5" title="5"></a>
<a class="sourceLine" id="cb14-6" title="6"><span class="kw">pp_foot</span>(<span class="dt">data =</span> italy_<span class="dv">2000</span>, <span class="dt">object =</span> fit1_stan, </a>
<a class="sourceLine" id="cb14-7" title="7">        <span class="dt">type =</span> <span class="st">&quot;matches&quot;</span>)</a></code></pre></div>
<p>The aggregated goal difference frequencies seem to be decently captured by the model’s replications: in the first plot, blue horizontal lines denote the observed goal differences frequencies registered in the dataset, whereas yellow jittered points denote the correspondent replications. Goal-difference of 0, corresponding to the draws occurrences, is only slightly underestimated by the model. However, in general there are no particular clues of model’s misfit.</p>
<p>In the second plot, the ordered observed goal differences are plotted against their replications (50% and 95% credible intervals), and from this plot also we do not have particular signs of model’s misfits.</p>
<p>Other useful PP checks, such as the overlap between data density and replicated data densities to check eventual inconsistencies, can be obtained through the standard use of the <code>bayesplot</code> package, in this case providing an approximation to a continuous distribution using an input kernel choice (<code>bw = 0.5</code> in the <code>ppc_dens_overlay</code> used below):</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1"><span class="co">## PPC densities overlay with the bayesplot package</span></a>
<a class="sourceLine" id="cb15-2" title="2"></a>
<a class="sourceLine" id="cb15-3" title="3"><span class="co"># extracting the replications</span></a>
<a class="sourceLine" id="cb15-4" title="4"></a>
<a class="sourceLine" id="cb15-5" title="5">sims &lt;-rstan<span class="op">::</span><span class="kw">extract</span>(fit1_stan)</a>
<a class="sourceLine" id="cb15-6" title="6">goal_diff &lt;-<span class="st"> </span>italy_<span class="dv">2000</span><span class="op">$</span>hgoal<span class="op">-</span>italy_<span class="dv">2000</span><span class="op">$</span>vgoal</a>
<a class="sourceLine" id="cb15-7" title="7"></a>
<a class="sourceLine" id="cb15-8" title="8"><span class="co"># plotting data density vs replications densities</span></a>
<a class="sourceLine" id="cb15-9" title="9"></a>
<a class="sourceLine" id="cb15-10" title="10"><span class="kw">ppc_dens_overlay</span>(goal_diff, sims<span class="op">$</span>y_rep[,,<span class="dv">1</span>]<span class="op">-</span>sims<span class="op">$</span>y_rep[,,<span class="dv">2</span>], <span class="dt">bw =</span> <span class="fl">0.5</span>)</a></code></pre></div>
<p>From this plot above we have the empirical confirmation that the goal difference is well captured by the static bivariate Poisson model. <!-- Let's fit now a student-$t$ model, by depicting posterior intervals for global abilities (in orange): --></p>
<!-- ```{r t, echo =TRUE, eval = FALSE} -->
<!-- ### Fit Stan models -->
<!-- ## no dynamics, no predictions -->
<!-- fit2 <- stan_foot(data = italy_2000_2002, -->
<!--                 model="student_t") # student_t -->
<!-- foot_abilities(fit2, italy_2000_2002) -->
<!-- ``` -->
</div>
<div id="predictions-and-predictive-accuracy" class="section level1">
<h1>Predictions and predictive accuracy</h1>
<div id="posterior-out-of-sample-probabilities" class="section level2">
<h2>Posterior out-of-sample probabilities</h2>
<p>The hottest feature in sports analytics is to obtain future predictions. By considering the <strong>posterior predictive distribution</strong> for future and observable data <span class="math inline">\(\tilde{\mathcal{D}}\)</span>, we acknowledge the whole model’s prediction uncertainty (which propagates from the posterior model’s uncertainty) and we can then generate observable values <span class="math inline">\(\tilde{D}\)</span> conditioned on the posterior model’s parameters estimates:</p>
<p><span class="math display">\[p(\tilde{\mathcal{D}}| \mathcal{D}) = \int p(\tilde{\mathcal{D}}| \boldsymbol{\theta}) \pi(\boldsymbol{\theta}| \mathcal{D}) d\boldsymbol{\theta}.\]</span></p>
<p>We may then predict test set matches by using the argument <code>predict</code> of the <code>stan_foot</code> function, for instance considering the last four weeks of the 2000/2001 season as the test set, and then computing posterior-results probabilities using the function <code>foot_prob</code> for two teams belonging to the test set, such as Reggina Calcio and AC Milan:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1"><span class="co">### Fit Stan models</span></a>
<a class="sourceLine" id="cb16-2" title="2"><span class="co">## weekly dynamics, predictions of last four weeks</span></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="co">## 4 chains &#39;n_iter&#39; iterations each</span></a>
<a class="sourceLine" id="cb16-4" title="4"></a>
<a class="sourceLine" id="cb16-5" title="5">fit4_stan &lt;-<span class="st"> </span><span class="kw">stan_foot</span>(<span class="dt">data =</span> italy_<span class="dv">2000</span>,</a>
<a class="sourceLine" id="cb16-6" title="6">                       <span class="dt">model=</span><span class="st">&quot;biv_pois&quot;</span>, </a>
<a class="sourceLine" id="cb16-7" title="7">                       <span class="dt">predict =</span> <span class="dv">36</span>,</a>
<a class="sourceLine" id="cb16-8" title="8">                       <span class="dt">dynamic_type =</span> <span class="st">&quot;weekly&quot;</span>,</a>
<a class="sourceLine" id="cb16-9" title="9">                       <span class="co">#cores = 4,</span></a>
<a class="sourceLine" id="cb16-10" title="10">                       <span class="dt">iter =</span> n_iter)  <span class="co"># biv poisson</span></a>
<a class="sourceLine" id="cb16-11" title="11"><span class="kw">foot_prob</span>(<span class="dt">object =</span> fit4_stan, <span class="dt">data =</span> italy_<span class="dv">2000</span>,</a>
<a class="sourceLine" id="cb16-12" title="12">          <span class="dt">home_team =</span> <span class="st">&quot;Reggina Calcio&quot;</span>,</a>
<a class="sourceLine" id="cb16-13" title="13">          <span class="dt">away_team=</span> <span class="st">&quot;AC Milan&quot;</span>)</a></code></pre></div>
<p>Darker regions are associated with higher posterior probabilities, whereas the red square corresponds to the actual observed result, 2-1 for Reggina Calcio. According to the posterior-results probabilities, this final observed result had in principle about a 5% probability to happen! (Remember, football is about rare events…).</p>
</div>
<div id="home-win-posterior-probabilities" class="section level2">
<h2>Home-win posterior probabilities</h2>
<p>We can also use the out-of-sample posterior-results probabilities to compute some aggregated <strong>home/draw/loss</strong> probabilities (based then on the <span class="math inline">\(S\)</span> draws from the MCMC method) for a given match:</p>
<p><span class="math display">\[\begin{align}
p_{\text{home}}= &amp;\ \textrm{Pr}(X&gt;Y) = \frac{1}{S}\sum_{s=1}^S| \tilde{x}^{(s)}&gt; \tilde{y}^{(s)}|\\
p_{\text{draw}} = &amp;\ \textrm{Pr}(X=Y) = \frac{1}{S}\sum_{s=1}^S| \tilde{x}^{(s)}= \tilde{y}^{(s)}|\\
p_{\text{loss}} = &amp;\ \textrm{Pr} (X&lt;Y)=\frac{1}{S}\sum_{s=1}^S| \tilde{x}^{(s)}&lt; \tilde{y}^{(s)}|,
\end{align}\]</span></p>
<p>where <span class="math inline">\((\tilde{x}^{(s)}, \tilde{y}^{(s)})\)</span> represents the <span class="math inline">\(s\)</span>-th MCMC pair of the future home goals and away goals for a given match, respectively. According to this scenario, we can depict the home-win posterior probabilities of a given test set through the function <code>foot_round_robin</code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="co">## Home win out-of-sample probabilities</span></a>
<a class="sourceLine" id="cb17-2" title="2"></a>
<a class="sourceLine" id="cb17-3" title="3"><span class="kw">foot_round_robin</span>(<span class="dt">data =</span> italy_<span class="dv">2000</span>, <span class="dt">object =</span> fit4_stan)</a></code></pre></div>
<p>Red cells denote more likely home-wins (close to 0.6), such as: Lazio Roma - Fiorentina (observed result: 3-0, home win), Lazio Roma - Udinese (observed result: 3-1, home win), Juventus - AC Perugia (observed result: 1-0, home win), Brescia Calcio - AS Bari (observed result: 3-1, home win). Conversely, lighter cells denote more likely away wins (close to 0.6), such as: AS Bari - AS Roma (observed result: 1-4, away win), AS Bari - Inter (observed result: 1-2, away win).</p>
<p>Finally, computations of well-known predictive measures on test set data such as the <strong>Brier score</strong> and the <strong>Epstein probability score</strong> will be included in the next package’s version, however they could be easily computed by the users.</p>
</div>
<div id="rank-league-reconstruction" class="section level2">
<h2>Rank-league reconstruction</h2>
<p>Statisticians and football amateurs are much interested in the final rank-league predictions. However, predicting the final rank position (along with the teams’ points) is often assimilated to an <em>oracle</em>, rather than a coherent statistical procedure.</p>
<p>We can provide here:</p>
<ul>
<li><strong>rank-league reconstruction</strong> for the first model <code>fit1_stan</code> by using the <strong>in-sample</strong> replications <span class="math inline">\(\mathcal{D}^{\text{rep}}\)</span> (yellow ribbons for the credible intervals, solid blue lines for the observed cumulated points):</li>
</ul>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1"><span class="co">## Rank league reconstruction</span></a>
<a class="sourceLine" id="cb18-2" title="2"></a>
<a class="sourceLine" id="cb18-3" title="3"><span class="co"># aggregated plot</span></a>
<a class="sourceLine" id="cb18-4" title="4"></a>
<a class="sourceLine" id="cb18-5" title="5"><span class="kw">foot_rank</span>(<span class="dt">data =</span> italy_<span class="dv">2000</span>, <span class="dt">object =</span> fit1_stan)</a>
<a class="sourceLine" id="cb18-6" title="6"></a>
<a class="sourceLine" id="cb18-7" title="7"><span class="co"># team-specific plot</span></a>
<a class="sourceLine" id="cb18-8" title="8"></a>
<a class="sourceLine" id="cb18-9" title="9"><span class="kw">foot_rank</span>(<span class="dt">data =</span> italy_<span class="dv">2000</span>, <span class="dt">object =</span> fit1_stan, <span class="dt">visualize =</span> <span class="st">&quot;individual&quot;</span>)</a></code></pre></div>
<ul>
<li><strong>rank-league prediction</strong> (aggregated or at team-level) for the fourth model <code>fit4_stan</code> by using the <strong>out-of-sample</strong> replications <span class="math inline">\(\tilde{\mathcal{D}}\)</span> (yellow ribbons for the credible intervals, solid blue lines for the observed cumulated points):</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1"><span class="co">## Rank predictions for individual teams</span></a>
<a class="sourceLine" id="cb19-2" title="2"></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="co"># aggregated plot</span></a>
<a class="sourceLine" id="cb19-4" title="4"></a>
<a class="sourceLine" id="cb19-5" title="5"><span class="kw">foot_rank</span>(<span class="dt">data =</span> italy_<span class="dv">2000</span>, <span class="dt">object =</span> fit4_stan)</a>
<a class="sourceLine" id="cb19-6" title="6"></a>
<a class="sourceLine" id="cb19-7" title="7"><span class="co"># team-specific plot</span></a>
<a class="sourceLine" id="cb19-8" title="8"></a>
<a class="sourceLine" id="cb19-9" title="9"><span class="kw">foot_rank</span>(italy_<span class="dv">2000</span>, fit4_stan, </a>
<a class="sourceLine" id="cb19-10" title="10">          <span class="dt">team_sel =</span> <span class="kw">c</span>(<span class="st">&quot;AC Milan&quot;</span>, <span class="st">&quot;AS Roma&quot;</span>), </a>
<a class="sourceLine" id="cb19-11" title="11">          <span class="dt">visualize =</span> <span class="st">&quot;individual&quot;</span>)</a>
<a class="sourceLine" id="cb19-12" title="12"></a>
<a class="sourceLine" id="cb19-13" title="13"><span class="kw">foot_rank</span>(italy_<span class="dv">2000</span>, fit4_stan, </a>
<a class="sourceLine" id="cb19-14" title="14">          <span class="dt">visualize =</span> <span class="st">&quot;individual&quot;</span>)</a></code></pre></div>
</div>
<div id="model-comparisons-looic-and-waic" class="section level2">
<h2>Model comparisons: LOOIC and WAIC</h2>
<p>Comparing statistical models in terms of some <strong>predictive information criteria</strong> should conclude many analysis and can be carried out by using the Leave-one-out cross-validation criterion (<strong>LOOIC</strong>) and the Watanabe Akaike Information criterion (<strong>WAIC</strong>) performed by using the <code>loo</code> package. For more details about LOOIC and WAIC, read the paper <span style="color:red"><span class="citation">Vehtari, Gelman, and Gabry (2017)</span></span>.</p>
<p>The general formulation for the predictive information criteria is the following:</p>
<p><span class="math display">\[ \text{crit}=-2 \widehat{\text{elpd}} =  -2 (\widehat{\text{lpd}}- \text{parameters penalty})\]</span></p>
<ul>
<li><p><span style="color:green"><span class="math inline">\(\widehat{\text{elpd}}\)</span></span>: estimate of the expected log predictive density of the fitted model.</p></li>
<li><p><span style="color:green"><span class="math inline">\(\widehat{\text{lpd}}\)</span></span> is a measure of the log predictive density of the fitted model.</p></li>
<li><p><span style="color:green">parameters penalty</span> is a penalization accounting for the effective number of parameters of the fitted model.</p></li>
</ul>
<p>The interpretation is the following: the lower is the value for an information criterion, and the better is the estimated model’s predictive accuracy. Moreover, if two competing models share the same value for the log predictive density, the model with less parameters is favored.</p>
<p>This is the <strong>Occam’s Razor</strong> occurring in statistics:</p>
<blockquote>
<p>“Frustra fit per plura quod potest fieri per pauciora”</p>
</blockquote>
<p>We can perform Bayesian model comparisons by using the <code>loo</code> and <code>waic</code> functions of the <code>loo</code> package. We are going to compare the static and the weekly dynamic models on the Italian Serie A 2000/2001:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1"><span class="co">### Model comparisons</span></a>
<a class="sourceLine" id="cb20-2" title="2"><span class="co">## LOOIC, loo function</span></a>
<a class="sourceLine" id="cb20-3" title="3"></a>
<a class="sourceLine" id="cb20-4" title="4"><span class="co"># extract pointwise log-likelihood</span></a>
<a class="sourceLine" id="cb20-5" title="5"></a>
<a class="sourceLine" id="cb20-6" title="6">log_lik_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">extract_log_lik</span>(fit1_stan)</a>
<a class="sourceLine" id="cb20-7" title="7">log_lik_<span class="dv">1</span>_t &lt;-<span class="st"> </span><span class="kw">extract_log_lik</span>(fit1_stan_t)</a>
<a class="sourceLine" id="cb20-8" title="8">log_lik_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">extract_log_lik</span>(fit2_stan)</a>
<a class="sourceLine" id="cb20-9" title="9">log_lik_<span class="dv">3</span> &lt;-<span class="st"> </span><span class="kw">extract_log_lik</span>(fit3_stan)</a>
<a class="sourceLine" id="cb20-10" title="10">log_lik_<span class="dv">3</span>_t &lt;-<span class="st"> </span><span class="kw">extract_log_lik</span>(fit3_stan_t)</a>
<a class="sourceLine" id="cb20-11" title="11"></a>
<a class="sourceLine" id="cb20-12" title="12"><span class="co"># compute loo</span></a>
<a class="sourceLine" id="cb20-13" title="13"></a>
<a class="sourceLine" id="cb20-14" title="14">loo1 &lt;-<span class="st"> </span><span class="kw">loo</span>(log_lik_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb20-15" title="15">loo1_t &lt;-<span class="st"> </span><span class="kw">loo</span>(log_lik_<span class="dv">1</span>_t)</a>
<a class="sourceLine" id="cb20-16" title="16">loo2 &lt;-<span class="st"> </span><span class="kw">loo</span>(log_lik_<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb20-17" title="17">loo3 &lt;-<span class="st"> </span><span class="kw">loo</span>(log_lik_<span class="dv">3</span>)</a>
<a class="sourceLine" id="cb20-18" title="18">loo3_t &lt;-<span class="st"> </span><span class="kw">loo</span>(log_lik_<span class="dv">3</span>_t)</a>
<a class="sourceLine" id="cb20-19" title="19"></a>
<a class="sourceLine" id="cb20-20" title="20"></a>
<a class="sourceLine" id="cb20-21" title="21"><span class="co"># compare three looic</span></a>
<a class="sourceLine" id="cb20-22" title="22"></a>
<a class="sourceLine" id="cb20-23" title="23"><span class="kw">compare</span>(loo1, loo1_t, loo2, loo3, loo3_t)</a></code></pre></div>
<p>According to the above model LOOIC comparisons, the weekly-dynamic double Poisson models attain the lowest LOOIC values and are then the favored models in terms of predictive accuracy. The static model’s <code>fit1_stan</code> final looic is suggesting that the assumption of static team-specific parameters is too restrictive and oversimplified to capture teams’ skills over time and make reliable predictions. Anyway, from model checking we have the suggestion that even the static model has a reliable goodness of fit and could be used for some simplified analysis not requiring complex dynamic patterns.</p>
</div>
</div>
<div id="extensions-in-next-versions" class="section level1">
<h1>Extensions in next versions</h1>
<p>Extensions and to-do list for the next package’s versions:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Data Web-scraping</strong>: automatic routine to scrape data from internet;</p></li>
<li><p><strong>More numerical outputs</strong>: posterior probabilities, confusion matrices, betting strategies, etc.;</p></li>
<li><p><strong>Diagnostics, pp checks</strong> designed for football;</p></li>
<li><p><strong>Zero-inflated models</strong></p></li>
<li><p><strong>Teams’ statistics</strong></p></li>
<li><p><strong>More covariates</strong> to be included in the model (possibly by users).</p></li>
<li><p><strong>More priors choices</strong></p></li>
</ol>
</div>
<div id="references" class="section level1">
<h1>References</h1>
<!-- ## Vignette Info -->
<!-- Note the various macros within the `vignette` section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette. -->
<!-- ## Styles -->
<!-- The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows: -->
<!--     output:  -->
<!--       rmarkdown::html_vignette: -->
<!--         css: mystyles.css -->
<!-- ## Figures -->
<!-- The figure sizes have been customised so that you can easily put two images side-by-side.  -->
<!-- ```{r, fig.show='hold'} -->
<!-- plot(1:10) -->
<!-- plot(10:1) -->
<!-- ``` -->
<!-- You can enable figure captions by `fig_caption: yes` in YAML: -->
<!--     output: -->
<!--       rmarkdown::html_vignette: -->
<!--         fig_caption: yes -->
<!-- Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**. -->
<!-- Also a quote using `>`: -->
<!-- > "He who gives up [code] safety for [code] speed deserves neither." -->
<!-- ([via](https://twitter.com/hadleywickham/status/504368538874703872)) -->
<!--%\usepackage[utf8]{inputenc}-->
<div id="refs" class="references">
<div id="ref-baio2010bayesian">
<p>Baio, Gianluca, and Marta Blangiardo. 2010. “Bayesian Hierarchical Model for the Prediction of Football Results.” <em>Journal of Applied Statistics</em> 37 (2): 253–64.</p>
</div>
<div id="ref-betancourt2017conceptual">
<p>Betancourt, Michael. 2017. “A Conceptual Introduction to Hamiltonian Monte Carlo.” <em>arXiv Preprint arXiv:1701.02434</em>.</p>
</div>
<div id="ref-egidi2018combining">
<p>Egidi, Leonardo, Francesco Pauli, and Nicola Torelli. 2018. “Combining Historical Data and Bookmakers’ Odds in Modelling Football Scores.” <em>Statistical Modelling</em> 18 (5-6): 436–59.</p>
</div>
<div id="ref-Egidi_Torelli_2020">
<p>Egidi, Leonardo, and Nicola Torelli. 2020. “Comparing Goal-Based and Result-Based Approaches in Modelling Football Outcomes.” <em>Social Indicators Research</em>, 1–13.</p>
</div>
<div id="ref-gelman2014stan">
<p>Gelman, Andrew. 2014. “Stan Goes to the World Cup.” <em>Statistical Modeling, Causal Inference, and Social Science Blog</em>. <a href="https://statmodeling.stat.columbia.edu/2014/07/13/stan-analyzes-world-cup-data/">https://statmodeling.stat.columbia.edu/2014/07/13/stan-analyzes-world-cup-data/</a>.</p>
</div>
<div id="ref-gelman2014bayesian">
<p>Gelman, Andrew, John B Carlin, Hal S Stern, and Donald B Rubin. 2014. <em>Bayesian Data Analysis</em>. Vol. 2. Chapman &amp; Hall/CRC Boca Raton, FL, USA.</p>
</div>
<div id="ref-groll2015prediction">
<p>Groll, Andreas, Gunther Schauberger, and Gerhard Tutz. 2015. “Prediction of Major International Soccer Tournaments Based on Team-Specific Regularized Poisson Regression: An Application to the Fifa World Cup 2014.” <em>Journal of Quantitative Analysis in Sports</em> 11 (2): 97–115.</p>
</div>
<div id="ref-karlis2003analysis">
<p>Karlis, Dimitris, and Ioannis Ntzoufras. 2003. “Analysis of Sports Data by Using Bivariate Poisson Models.” <em>Journal of the Royal Statistical Society: Series D (the Statistician)</em> 52 (3): 381–93.</p>
</div>
<div id="ref-karlis2009bayesian">
<p>———. 2009. “Bayesian Modelling of Football Outcomes: Using the Skellam’s Distribution for the Goal Difference.” <em>IMA Journal of Management Mathematics</em> 20 (2): 133–45.</p>
</div>
<div id="ref-koopman2015dynamic">
<p>Koopman, Siem Jan, and Rutger Lit. 2015. “A Dynamic Bivariate Poisson Model for Analysing and Forecasting Match Results in the English Premier League.” <em>Journal of the Royal Statistical Society: Series A (Statistics in Society)</em> 178 (1): 167–86.</p>
</div>
<div id="ref-owen2011dynamic">
<p>Owen, Alun. 2011. “Dynamic Bayesian Forecasting Models of Football Match Outcomes with Estimation of the Evolution Variance Parameter.” <em>IMA Journal of Management Mathematics</em> 22 (2): 99–113.</p>
</div>
<div id="ref-Casella_Robert_2013">
<p>Robert, Christian, and George Casella. 2013. <em>Monte Carlo Statistical Methods</em>. Springer Science &amp; Business Media.</p>
</div>
<div id="ref-rstan2020">
<p>Stan Development Team. 2020. “RStan: The R Interface to Stan.” <a href="https://mc-stan.org/">https://mc-stan.org/</a>.</p>
</div>
<div id="ref-vehtari2016practical">
<p>Vehtari, Aki, Andrew Gelman, and Jonah Gabry. 2017. “Practical Bayesian Model Evaluation Using Leave-One-Out Cross-Validation and WAIC.” <em>Statistics and Computing</em> 27 (5): 1413–32.</p>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
